# 月份循環處理說明

## 🔧 問題解決

由於 `crawl_50.py` 一次只能處理一個月的數據，`download_news_url_parallel.sh` 已經升級為支持**月份循環處理**版本。

## ✨ 新功能特點

### 自動月份分割
- **智能分割**: 將 2021-01-01 到 2025-05-23 分割成 53 個月份
- **獨立處理**: 每個月份單獨調用 `crawl_50.py`
- **自動合併**: 月份數據自動合併成最終 JSON 文件

### 處理流程
```
公司 A:
├── 2021-01-01:2021-01-31 → temp_A/A_2021-01-01.json
├── 2021-02-01:2021-02-28 → temp_A/A_2021-02-01.json
├── ...53個月份...
└── 自動合併 → sp500_news_urls/A.json

公司 B:
├── 2021-01-01:2021-01-31 → temp_B/B_2021-01-01.json
├── 2021-02-01:2021-02-28 → temp_B/B_2021-02-01.json
├── ...53個月份...
└── 自動合併 → sp500_news_urls/B.json
```

### 容錯機制
- **進度追蹤**: 已完成的公司會被記錄，重新執行時自動跳過
- **部分失敗處理**: 即使某些月份失敗，成功的月份仍會被合併
- **臨時文件管理**: 處理完成後自動清理臨時文件

## 📊 性能統計

### 時間估算
- **總月份**: 53個月份
- **單月處理時間**: 約 1-3 分鐘（取決於新聞數量）
- **預估單公司總時間**: 53-159 分鐘
- **並行處理**: 4個公司同時處理

### 資源使用
- **並發控制**: 最多4個公司同時處理
- **API限制**: 每月份之間有1秒延遲
- **超時設定**: 每月份最多120秒

## 🚀 執行方式

### 直接執行
```bash
cd news_sentiment_analysis/finnhub_newsdata/
./download_news_url_parallel.sh
```

### 監控進度
```bash
# 實時查看日誌
tail -f download_log.txt

# 查看已完成的公司
cat download_progress.txt
```

### 重新執行
如果中斷或部分失敗：
```bash
# 直接重新執行，會自動跳過已完成的公司
./download_news_url_parallel.sh
```

## 📁 輸出結構

```
sp500_news_urls/
├── AAPL.json          # 蘋果公司完整4年數據
├── MSFT.json          # 微軟公司完整4年數據
├── GOOGL.json         # Google完整4年數據
└── ...                # 其他S&P500公司

# 臨時目錄（處理過程中）
temp_AAPL/
├── AAPL_2021-01-01.json
├── AAPL_2021-02-01.json
└── ...
```

## 🔍 日誌示例

```
2025-01-XX 10:30:15: [START] 開始處理公司: AAPL
2025-01-XX 10:30:15: [INFO] AAPL: 需要處理 53 個月份
2025-01-XX 10:30:16: [MONTH] AAPL: 處理月份 1/53 (2021-01-01 到 2021-01-31)
2025-01-XX 10:31:20: [MONTH-OK] AAPL: 月份 2021-01-01 成功
2025-01-XX 10:31:22: [MONTH] AAPL: 處理月份 2/53 (2021-02-01 到 2021-02-28)
...
2025-01-XX 12:45:30: [MERGE] AAPL: 開始合併 51 個月份的數據
2025-01-XX 12:45:32: [SUCCESS] ✅ 成功完成 AAPL (處理了 51/53 個月份)
```

## ⚠️ 注意事項

1. **處理時間**: 完整處理所有S&P500公司需要數小時到數天
2. **網絡穩定**: 建議在網絡穩定的環境下執行
3. **API限制**: 如遇到頻率限制，會自動重試
4. **磁盤空間**: 確保有足夠空間存放臨時文件和最終結果

## 🛠️ 問題排除

### 常見問題
- **python-dateutil 未安裝**: 腳本會自動檢查並提示安裝
- **JSON合併失敗**: 檢查臨時目錄是否有權限問題
- **某月份持續失敗**: 可能是該時間段無新聞數據，屬正常現象

### 手動檢查
```bash
# 檢查某公司的臨時文件
ls -la sp500_news_urls/temp_AAPL/

# 檢查最終合併結果
jq '.total_news_fetched' sp500_news_urls/AAPL.json
``` 